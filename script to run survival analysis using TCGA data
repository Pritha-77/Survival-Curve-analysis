
setwd("D:/survivalAnalysis")

#BiocManager::install("TCGAbiolinks")
library(TCGAbiolinks)
#remove.packages("TCGAbiolinks")

#remotes::install_github("https://github.com/BioinformaticsFMRP/TCGAbiolinks",ref = "devel")
#BiocManager::install("survminer")
library(survminer)
#BiocManager::install("survival")
library(survival)
#BiocManager::install("SummarizedExperiment")
library(SummarizedExperiment)
library(tidyverse)
library(DESeq2)

# getting clinical data for TCGA-coad cohort -------------------
clinical_coad <- GDCquery_clinic(project = "TCGA-COAD")
any(colnames(clinical_coad) %in% c("vital_status", "days_to_last_follow_up", "days_to_death"))
which(colnames(clinical_coad) %in% c("vital_status", "days_to_last_follow_up", "days_to_death"))
clinical_coad[,c(9,42,50)]


# looking at some variables associated with survival 
table(clinical_coad$vital_status)

# days_to_death, that is the number of days passed from the initial diagnosis to the patientâ€™s death (clearly, this is only relevant for dead patients)
# days_to_last_follow_up that is the number of days passed from the initial diagnosis to the last visit.

# change certain values the way they are encoded
clinical_coad$deceased <- ifelse(clinical_coad$vital_status == "Alive", FALSE, TRUE)
table(clinical_coad$deceased)

# create an "overall survival" variable that is equal to days_to_death
# for dead patients, and to days_to_last_follow_up for patients who
# are still alive
clinical_coad$overall_survival <- ifelse(clinical_coad$vital_status == "Alive",
                                         clinical_coad$days_to_last_follow_up,
                                         clinical_coad$days_to_death)


table(clinical_coad$overall_survival)


# get gene expression data -----------

# build a query to get gene expression data for entire cohort
query_coad_all = GDCquery(
  project = "TCGA-COAD",
  data.category = "Transcriptome Profiling", # parameter enforced by GDCquery
  experimental.strategy = "RNA-Seq",
  workflow.type = "STAR - Counts",
  data.type = "Gene Expression Quantification",
  sample.type = "Primary Tumor",
  access = "open")

output_coad <- getResults(query_coad_all)
# get primary tissue sample barcodes
tumor <- output_coad$cases[1:481]
# OR
tumor <- output_coad[output_coad$sample_type == "Primary Tumor", "cases"][1:481]
tumor

# # get gene expression data from 481 primary tumors 
query_coad <- GDCquery(
  project = "TCGA-COAD",
  data.category = "Transcriptome Profiling", # parameter enforced by GDCquery
  experimental.strategy = "RNA-Seq",
  workflow.type = "STAR - Counts",
  data.type = "Gene Expression Quantification",
  sample.type = c("Primary Tumor", "Solid Tissue Normal"),
  access = "open",
  barcode = tumor)

# download data
GDCdownload(query_coad)

# get counts
tcga_coad_data <- GDCprepare(query_coad, summarizedExperiment = TRUE)
coad_matrix <- assay(tcga_coad_data, "unstranded")
coad_matrix[1:10,1:10]


# extract gene and sample metadata from summarizedExperiment object
gene_metadata <- as.data.frame(rowData(tcga_coad_data))
coldata <- as.data.frame(colData(tcga_coad_data))


# vst transform counts to be used in survival analysis ---------------
# Setting up countData object   
dds <- DESeqDataSetFromMatrix(countData = coad_matrix,
                              colData = coldata,
                              design = ~ 1)

# Removing genes with sum total of 10 reads across all samples
keep <- rowSums(counts(dds)) >= 10
dds <- dds[keep,]


# vst 
vsd <- vst(dds, blind=FALSE)
coad_matrix_vst <- assay(vsd)
coad_matrix_vst[1:10,1:10]


# Get data for PRKCZ gene and add gene metadata information to it -------------
coad_PRKCZ <- coad_matrix_vst %>% 
  as.data.frame() %>% 
  rownames_to_column(var = 'gene_id') %>% 
  gather(key = 'case_id', value = 'counts', -gene_id) %>% 
  left_join(., gene_metadata, by = "gene_id") %>% 
  filter(gene_name == "PRKCZ")


# get median value
median_value <- median(coad_PRKCZ$counts)

# denote which cases have higher or lower expression than median count
coad_PRKCZ$strata <- ifelse(coad_PRKCZ$counts >= median_value, "HIGH", "LOW")

# Add clinical information to coad_PRKCZ
coad_PRKCZ$case_id <- gsub('-01.*', '', coad_PRKCZ$case_id)
coad_PRKCZ <- merge(coad_PRKCZ, clinical_coad, by.x = 'case_id', by.y = 'submitter_id')


# fitting survival curve -----------
fit <- survfit(Surv(overall_survival, deceased) ~ strata, data = coad_PRKCZ)
fit
ggsurvplot(fit,
           data = coad_PRKCZ,
           pval = T,
           risk.table = T)

ggsurvplot(fit,
           data = coad_PRKCZ,
           pval = TRUE,
           risk.table = TRUE,
           risk.table.y.text = FALSE,
           palette = c("#E7B800", "#2E9FDF"),
           legend.title = "PRKCZ Expression",
           legend.labs = c("Low", "High"),
           xlab = "Time (days)",
           ylab = "Overall Survival Probability",
           ggtheme = theme_minimal(),
           title = "PRKCZ Survival Analysis")




fit2 <- survdiff(Surv(overall_survival, deceased) ~ strata, data = coad_PRKCZ)

fit2
